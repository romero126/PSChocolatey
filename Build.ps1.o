[CmdletBinding()]
param(
    [ValidateSet("Build", "Test", "Execute", "Example","Example.Interactive")]
    [String]$Action,
    [String]$TestName = "*"
)

$Menu = @(
    [PSCustomObject]@{
        Name            = "Build"
        Description     = "*** Nothing to do here ***"
        ScriptBlock     = {
            $ModulePath = "$PSScriptRoot/Module/PSAdmin/PSAdmin.psm1"

            Remove-Item -Path $PSScriptRoot/Module -Recurse -ErrorAction SilentlyContinue -Force -Confirm:$false | Out-Null
            New-Item -Path $PSScriptRoot/Module/PSAdmin -ItemType Directory -ErrorAction SilentlyContinue -Force | Out-Null            
            Copy-Item "$PSScriptRoot/Source/*" -Exclude *.cs, "src" -Recurse -Destination "$PSScriptRoot/Module/PSAdmin/" -Force
            function Local:Compile {
                [CmdletBinding()]
                param (
                    [Parameter(Mandatory)]
                    [System.String]$Path,
                    [Parameter(Mandatory)]
                    [System.String]$Module,
                    [Parameter(Mandatory)]
                    [System.String]$Build
                )

                $ReferenceAssemblyManifest = @(
                    "System.Data"
                    "System.Data.Common"
                    "System.ComponentModel.Primitives"
                    "System.Management.Automation"
                    "System.Text.RegularExpressions"
                    "System.Collections"
                )
                
                $ObjectList = Get-ChildItem -Path $Path/*.cs -Recurse
                $ReferencedAssemblies = $ReferenceAssemblyManifest + (get-childitem -Path $PSScriptRoot/Module/$Module/$Build/*.dll)
                Write-Host "Compiling DLL for $Build" -ForegroundColor Cyan
                Add-Type -Path $ObjectList -OutputAssembly $PSScriptRoot/Module/$Module/$Build/$Module.dll -ReferencedAssemblies $ReferencedAssemblies
            }


            Compile -Path $PSScriptRoot/Source/ -Module "PSAdmin" -Build x64
            Compile -Path $PSScriptRoot/Source/ -Module "PSAdmin" -Build x86
            Compile -Path $PSScriptRoot/Source/ -Module "PSAdmin" -Build mac
        }
    },
    
    [PSCustomObject]@{
        Name            = "Test"
        Description     = "Pester Tests"
        ScriptBlock     = {
            Write-Warning "Beginning Unit Tests for PSAdmin"
            $PesterItems = Get-ChildItem ("{0}/Tests/{1}.Tests.ps1" -f $PSScriptRoot, $TestName)
            #$PesterItems = Get-ChildItem $PSScriptRoot/Tests/*.Tests.ps1
            Invoke-Pester $PesterItems
        }
    },
    [PSCustomObject]@{
        Name            = "Execute"
        Description     = "*** Nothing to do here ***"
        ScriptBlock     = {
            Write-Warning "Nothing to Execute"
        }
    },
    [PSCustomObject]@{
        Name            = "Example"
        Description     = "Adds your computer to the database."
        ScriptBlock     = {
            Write-Warning "Starting Example"
            . "$PSScriptRoot\Examples\Example.ps1"
        }
    },
    [PSCustomObject]@{
        Name            = "Example.Interactive"
        Description     = "Ineractive Powershell Window to interact with the database."
        ScriptBlock     = {
            $null = Start-Process powershell ("-noexit -command . $PSScriptRoot/Examples/Example.Interactive.ps1") -PassThru
        }       
    }
)

if (!$Action) {
    Write-Warning "Cannot Determine Desired Action"
    Write-host "Possible Options", $MenuItem.Name
}

$MenuItem = $Menu | Where-Object Name -eq $Action

Write-Host "Calling Action", $MenuItem.Action

if ($MenuItem.ScriptBlock) {
    . $MenuItem.ScriptBlock
}

<#
Import-Module "$PSScriptRoot\Module\PSChocolatey\PSChocolatey.psm1" -force
Open-PSChocolatey


$Commands = Get-PSChocolateyCommands

foreach ($Command in $Commands.GetEnumerator())
{
    $CheckCommand = Get-Command "*-PSChocolatey$($Command.Key)"
    if (-not $CheckCommand)
    {
        $BlackList = ("Version", "Update")
        if ($BlackList -contains $Command.Key) { Continue; }
        $Command
    }
}
#List
#Export-PSChocolateyCommand -Name "List" -Verb "Get" | Out-File $PSScriptRoot\Module\PSChocolatey\PSChocolateyList\Get-PSChocolateyList.ps1

#Source
#Export-PSChocolateyCommand -Name "Source" -Verb "Get"       | Out-File $PSScriptRoot\Module\PSChocolatey\PSChocolateySource\Get-PSChocolateySource.ps1
#Export-PSChocolateyCommand -Name "Source" -Verb "Add"       | Out-File $PSScriptRoot\Module\PSChocolatey\PSChocolateySource\Add-PSChocolateySource.ps1
#Export-PSChocolateyCommand -Name "Source" -Verb "Enable"    | Out-File $PSScriptRoot\Module\PSChocolatey\PSChocolateySource\Enable-PSChocolateySource.ps1
#Export-PSChocolateyCommand -Name "Source" -Verb "Disable"   | Out-File $PSScriptRoot\Module\PSChocolatey\PSChocolateySource\Disable-PSChocolateySource.ps1
#Export-PSChocolateyCommand -Name "Source" -Verb "Remove"    | Out-File $PSScriptRoot\Module\PSChocolatey\PSChocolateySource\Remove-PSChocolateySource.ps1

#New
#Export-PSChocolateyCommand -Name "New" -Verb "Add"      | Out-File $PSScriptRoot\Module\PSChocolatey\PSChocolateySource\Add-PSChocolateyNew.ps1

#OutDated
#Export-PSChocolateyCommand -Name "OutDated" -Verb "Get"      | Out-File $PSScriptRoot\Module\PSChocolatey\PSChocolateyOutdated\Get-PSChocolateyOutdated.ps1

#Install
#Export-PSChocolateyCommand -Name "Install" -Verb "Install"      | Out-File $PSScriptRoot\Module\PSChocolatey\PSChocolateyInstall\Install-PSChocolateyInstall.ps1

#Upgrade
#Export-PSChocolateyCommand -Name "Upgrade" -Verb "Update"      | Out-File $PSScriptRoot\Module\PSChocolatey\PSChocolateyUpgrade\Update-PSChocolateyUpgrade.ps1


#Uninstall
#Export-PSChocolateyCommand -Name "Uninstall" -Verb "Uninstall"      | Out-File $PSScriptRoot\Module\PSChocolatey\PSChocolateyUninstall\Uninstall-PSChocolateyUninstall.ps1



#>